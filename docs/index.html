<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Uditya — Profile Views (Live)</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body{margin:0;background:#0b1020;color:#eaeefb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{padding:16px 20px;border-bottom:1px solid #1b2340;display:flex;align-items:center;gap:12px}
    .dot{width:10px;height:10px;border-radius:50%;background:#07e29e;box-shadow:0 0 12px #07e29e}
    .pill{background:#111a37;border:1px solid #1f2b55;border-radius:999px;padding:8px 12px}
    main{padding:18px;max-width:1100px;margin:0 auto}
    #chart{height:480px;}
    .row{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
    select,button{background:#101a35;color:#eaeefb;border:1px solid #2b3a77;border-radius:10px;padding:8px 10px}
    .kpi{display:inline-block;margin-right:14px}
    a{color:#8cc8ff}
    footer{opacity:.7;padding:18px;text-align:center;border-top:1px solid #1b2340;margin-top:20px}
  </style>
</head>
<body>
  <header>
    <div class="dot"></div>
    <div><strong>Uditya — Profile Views (Live)</strong></div>
    <div class="pill" id="lastUpdated">Loading…</div>
  </header>

  <main>
    <div class="row">
      <div class="kpi">Total: <strong id="totalViews">—</strong></div>
      <div class="kpi">Today: <strong id="todayViews">—</strong></div>
      <div class="kpi">This Week: <strong id="weekViews">—</strong></div>
      <div class="kpi">This Month: <strong id="monthViews">—</strong></div>
      <span style="flex:1"></span>
      <label>View:</label>
      <select id="mode">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
        <option value="cumulative">Cumulative</option>
      </select>
      <label>Smoothing:</label>
      <select id="smooth">
        <option value="0">Off</option>
        <option value="3">3-day</option>
        <option value="7" selected>7-day</option>
      </select>
      <button id="refresh">Refresh</button>
    </div>

    <div id="chart"></div>
    <p>Data source: <code>docs/data/views.json</code> (auto-updated by GitHub Actions every 5 minutes). This page refreshes data every 60s.</p>
  </main>

  <footer>
    Made with Plotly • <a href="https://github.com/udityamerit/udityamerit">Repo</a>
  </footer>

<script>
const DATA_URL = "./data/views.json";

async function fetchData() {
  const bust = Date.now(); // cache-bust
  const res = await fetch(DATA_URL + "?t=" + bust, {cache: "no-cache"});
  if (!res.ok) throw new Error("Failed to load views.json");
  return res.json();
}

function groupSum(points, unit) {
  // points: [{date, total}] -> compute daily deltas then resample
  const day = 24*3600*1000;
  const byDay = {};
  for (let i=1;i<points.length;i++){
    const d = new Date(points[i].date);
    const prev = points[i-1].total;
    const cur  = points[i].total;
    const inc = Math.max(0, cur - prev);
    const key = new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
    byDay[key] = (byDay[key]||0) + inc;
  }
  const entries = Object.entries(byDay).sort((a,b)=>a[0].localeCompare(b[0]));
  if (unit==="daily") return entries;
  // weekly / monthly / yearly
  const agg = {};
  for (const [k,v] of entries){
    const dt = new Date(k+"T00:00:00Z");
    let key;
    if (unit==="weekly"){
      // ISO week key
      const tmp = new Date(dt);
      const dayNum = (dt.getUTCDay()+6)%7;
      tmp.setUTCDate(dt.getUTCDate()-dayNum+3);
      const week1 = new Date(Date.UTC(tmp.getUTCFullYear(),0,4));
      const weekNo = 1 + Math.round(((tmp - week1)/day + ((week1.getUTCDay()+6)%7))/7);
      key = `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
    } else if (unit==="monthly"){
      key = `${dt.getUTCFullYear()}-${String(dt.getUTCMonth()+1).padStart(2,"0")}`;
    } else if (unit==="yearly"){
      key = `${dt.getUTCFullYear()}`;
    } else {
      key = k;
    }
    agg[key]=(agg[key]||0)+v;
  }
  return Object.entries(agg).sort((a,b)=>a[0].localeCompare(b[0]));
}

function movingAvg(arr, k){
  if (k<=1) return arr;
  const out=[];
  for(let i=0;i<arr.length;i++){
    const start=Math.max(0,i-k+1);
    const slice=arr.slice(start,i+1).map(x=>x[1]);
    const mean=slice.reduce((a,b)=>a+b,0)/slice.length;
    out.push([arr[i][0], mean]);
  }
  return out;
}

function toDateLabels(pairs){
  return pairs.map(p=>p[0]);
}
function toValues(pairs){
  return pairs.map(p=>p[1]);
}

let rawData=null;

function render(mode="daily", sm=7){
  if (!rawData) return;
  const series = mode==="cumulative"
    ? rawData.map(p=>[p.date, p.total])
    : groupSum(rawData, mode);

  const smoothed = (mode==="cumulative" || sm==0) ? series : movingAvg(series, sm);

  const trace = {
    x: toDateLabels(smoothed),
    y: toValues(smoothed),
    mode: 'lines+markers',
    line: {shape: 'spline', width: 4},
    marker: {size: 8},
    hovertemplate: '%{x}<br><b>%{y}</b> views<extra></extra>',
    name: mode.toUpperCase()
  };

  const layout = {
    paper_bgcolor:'#0b1020',
    plot_bgcolor:'#0b1020',
    font:{color:'#eaeefb'},
    margin:{l:60,r:30,t:50,b:60},
    title:{text:`Profile Views — ${mode.toUpperCase()}${sm>0&&mode!=='cumulative'?' (MA'+sm+')':''}`},
    xaxis:{gridcolor:'#1b2340'},
    yaxis:{gridcolor:'#1b2340'}
  };

  Plotly.newPlot('chart', [trace], layout, {displaylogo:false, responsive:true});
}

async function refresh(){
  try{
    const data = await fetchData();
    rawData = data.points;
    // KPIs
    document.getElementById('totalViews').textContent = data.points.at(-1).total.toLocaleString();
    document.getElementById('lastUpdated').textContent = "Updated: " + new Date(data.generated_at).toLocaleString();
    // today/week/month
    const daily = groupSum(rawData, 'daily');
    document.getElementById('todayViews').textContent = daily.at(-1)?.[1] ?? 0;
    const weekly = groupSum(rawData, 'weekly');
    document.getElementById('weekViews').textContent = weekly.at(-1)?.[1] ?? 0;
    const monthly = groupSum(rawData, 'monthly');
    document.getElementById('monthViews').textContent = monthly.at(-1)?.[1] ?? 0;

    render(document.getElementById('mode').value, +document.getElementById('smooth').value);
  }catch(e){
    console.error(e);
    document.getElementById('lastUpdated').textContent = "Failed to load data";
  }
}

document.getElementById('mode').addEventListener('change', ()=>render(mode.value, +smooth.value));
document.getElementById('smooth').addEventListener('change', ()=>render(mode.value, +smooth.value));
document.getElementById('refresh').addEventListener('click', refresh);

// Auto refresh every 60s
setInterval(refresh, 60000);
refresh();
</script>
</body>
</html>
